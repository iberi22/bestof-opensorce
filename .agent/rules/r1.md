---
trigger: always_on
---

# ğŸ“‹ Reglas de Desarrollo: Open Source Video Generator

_Ãšltima ActualizaciÃ³n: 23 de noviembre de 2025_

### ğŸ”„ Project Awareness & Context
- **Always read `PLANNING.md`** at the start of a new conversation to understand the project's architecture, goals, style, and constraints.
- **Check `TASK.md`** before starting a new task. If the task isnâ€™t listed, add it with a brief description and today's date.
- **Use consistent naming conventions, file structure, and architecture patterns** as described in `PLANNING.md`.

### ğŸ§± Code Structure & Modularity
- **Never create a file longer than 800 lines of code.** If a file approaches this limit, refactor by splitting it into modules or helper files.
- **Organize code into clearly separated modules**, grouped by feature or responsibility.
- **Use clear, consistent imports** (prefer relative imports within packages).


## ğŸ”„ Contexto del Proyecto

### VisiÃ³n General
- **Objetivo:** Sistema automatizado para detectar repositorios Open Source de alta calidad, generar guiones con IA, grabar tours visuales y producir videos narrados.
- **FilosofÃ­a:** "Serverless" first (GitHub Actions) pero con soporte local robusto (Foundry Local).
- **Stack Principal:** Python 3.11+, Playwright, MoviePy, Google Gemini / Foundry Local.

### Arquitectura del Sistema
El proyecto sigue una arquitectura modular estricta:
1.  **Scanner (`src/scanner`):** Ojos del sistema. Filtra repositorios usando criterios de calidad (CI, Licencia, Actividad).
2.  **Agents (`src/agents`):** Cerebro. Genera guiones y anÃ¡lisis usando LLMs (Gemini/Foundry).
3.  **Engine (`src/engine`):** Manos.
    *   `visuals.py`: Controla el navegador (Playwright) para grabar.
    *   `renderer.py`: Edita video y audio (MoviePy, EdgeTTS).
4.  **Uploader (`src/uploader`):** Voz. Publica el contenido final.

## ğŸ§± EstÃ¡ndares de CÃ³digo

### Python
- **Estilo:** Adherencia estricta a **PEP 8**.
- **Tipado:** Uso obligatorio de **Type Hints** en firmas de funciones y mÃ©todos.
- **Docstrings:** Formato Google Style para todas las clases y funciones pÃºblicas.
- **Imports:** Organizados: EstÃ¡ndar -> Terceros -> Locales.

```python
# Ejemplo de firma correcta
def generate_script(self, repo_data: Dict[str, Any]) -> Optional[Dict[str, str]]:
    """Genera un guion de video basado en datos del repositorio."""
    ...
```

### Manejo de Errores y Logging
- **No usar `print`:** Usar siempre el mÃ³dulo `logging`.
- **Excepciones:** Capturar excepciones especÃ­ficas, nunca `except Exception:` vacÃ­o sin re-raise o log.
- **Fail-fast:** Si falta una configuraciÃ³n crÃ­tica (ej. API Key), fallar inmediatamente al inicio.

## ğŸ¤– Reglas de IA (LLMs)

### Hibridez Obligatoria
Todo componente de IA debe soportar dos modos:
1.  **Cloud (Gemini):** Para ejecuciÃ³n en CI/CD (GitHub Actions). Requiere `GOOGLE_API_KEY`.
2.  **Local (Foundry):** Para desarrollo local sin costos. Requiere `foundry-local-sdk`.

### IngenierÃ­a de Prompts
- Los prompts deben solicitar salidas estructuradas (JSON) para facilitar el parsing.
- Incluir instrucciones de "Persona" (ej. "ActÃºa como un Ingeniero DevOps Senior").

## ğŸ§ª Testing & Reliability

- **Always create Pytest unit tests for new features** (functions, classes, routes, etc).
- **After updating any logic**, check whether existing unit tests need to be updated. If so, do it.
- **Tests should live in a `/tests` folder** mirroring the main app structure.
  - Include at least:
    - 1 test for expected use
    - 1 edge case
    - 1 failure case


### Criterios de ValidaciÃ³n de Repositorios
El Scanner debe ser implacable. Solo procesar si:
- [x] Tiene Licencia Open Source vÃ¡lida.
- [x] Tiene CI/CD pasando (GitHub Actions success).
- [x] README sustancial (>500 chars).
- [x] No es un proyecto "toy" (alpha, test, demo).

### Pruebas
- **Unitarias:** Usar `pytest`.
- **Mocking:** NUNCA llamar a APIs reales (GitHub, YouTube, Gemini) en los tests automÃ¡ticos. Usar mocks.

## ğŸš€ DevOps y CI/CD

### GitHub Actions
- **Idempotencia:** Los workflows deben poder correr mÃºltiples veces sin efectos adversos (ej. no subir el mismo video dos veces).
- **Headless:** Todo cÃ³digo de UI (Playwright) debe soportar ejecuciÃ³n `--headless`.
- **Secretos:** Las credenciales se leen EXCLUSIVAMENTE de variables de entorno.

### Docker
- El contenedor debe incluir todas las dependencias de sistema (FFmpeg, Browsers) para garantizar que la generaciÃ³n de video funcione idÃ©ntica en local y en la nube.

## ğŸ”’ Seguridad
- **.gitignore:** Verificar siempre que `output/`, `.env` y `__pycache__` estÃ©n ignorados.
- **SanitizaciÃ³n:** Limpiar nombres de archivos generados para evitar inyecciones de comandos o errores de sistema de archivos.

### âœ… Task Completion
- **Mark completed tasks in `TASK.md`** immediately after finishing them.
- Add new sub-tasks or TODOs discovered during development to `TASK.md` under a â€œDiscovered During Workâ€ section.

### ğŸ“š Documentation & Explainability
- **Update `README.md`** when new features are added, dependencies change, or setup steps are modified.
- **Comment non-obvious code** and ensure everything is understandable to a mid-level developer.
- When writing complex logic, **add an inline `# Reason:` comment** explaining the why, not just the what.

### ğŸ§  AI Behavior Rules
- **Never assume missing context. Ask questions if uncertain.**
- **Never hallucinate libraries or functions** â€“ only use known, verified Python packages.
- **Always confirm file paths and module names** exist before referencing them in code or tests.
- **Never delete or overwrite existing code** unless explicitly instructed to or if part of a task from `TASK.md`